/*! currently13 2014-03-17 */
function migrate_delete_resources0(){var a=mongoose.model("Resource");console.log("Removing existing resources..."),a.find().remove(function(a,b){console.log(" ... removed "+b),migrate0()})}function migrate0(){console.log("Reading CSVs"),fs.readdir(path,function(a,b){cms.utils.forEach(b,read_csv,migrate1)}),cms.models.Log.remove(function(a,b){console.log("REMOVED LOGS ",a,b)})}function migrate1(){cms.utils.forEach(data.Resource.array,create_resource,migrate2,20)}function migrate2(){var a=0,b=["Inventory","Artist","Catalog","Contact","Essay","Exhibition","News","Page"];cms.utils.forEach(b,function(c,d){_job&&_job.progress(a,b.length),repopulate(c,d),a++},function(){_done&&(_job=null,_done())})}function repopulate(a,b){var c=mongoose.model(a);c.find().remove(function(c,d){console.log("Repopulating "+a+" ... removed "+d+" old records."),_job&&_job.log("Repopulating "+a+" ... removed "+d+" old records."),cms.utils.forEach(data[a].array,function(b,c){create(a,b,c)},b)})}function read_csv(a,b){var c,d,e=function(a){return"NULL"==a?null:a},f=[],g={};csv().from.path(path+a,{delimiter:",",escape:'"'}).on("record",function(a,b){if(0==b)d=a[0];else if(1==b)c=a;else{for(var h={},i=0;i<c.length;i++)h[c[i]]=e(a[i]);f.push(h),g[h.id]=h}}).on("end",function(){data[d]={name:d,array:f,map:g},b()}).on("error",function(a){console.error("X",a.message),b(a)})}function create_resource(a,b){var c=a["path-token"],d="http://www.hackettmill.com:81/hm_resources/"+c,e=mongoose.model("Resource");e.findOne({path:c},function(f,g){g?(a.model=g,b()):cloudinary.uploader.upload(d,function(d){var f=new e;f.path=c,f.meta=d,f.meta.thumb=cms.get_preview_url(d),f.save(function(c,d){a.model=d,console.log("Uploaded ",d.meta.public_id,d.meta.thumb),b()})},{public_id:prefix+"/"+uuid.v4()})})}function create(a,b,c){var d=mongoose.model(a),e=new d,f=cms.meta.info(a);for(var g in f)"creator"!=g&&"modified"!=g&&"created"!=g&&b[g]&&(e[g]=get_field_val(f[g],b[g]));e.state=workflow.PUBLISHED,e.save(function(a,d){a&&console.log(a),b.model=d,c()})}function get_field_val(a,b){switch(a.type){case"Reference":if(a.is_array){for(var c=[],d=b.substring(1,b.length-1).split(","),e=0;e<d.length;e++){var f=get_ref_val(d[e]);f&&c.push(f)}return c}return get_ref_val(b);case"Date":var g=b.split("."),h=g[5].split(" "),i=new Date(Number(g[0]),Number(g[1])-1,Number(g[2]),Number(g[3]),Number(g[4]),Number(h[0]));return i;case"Number":return Number(b);case"Boolean":return Boolean(b);default:return b}}function get_ref_val(a){var b=a.split(":");try{var c=b[0].trim(),d=b[1].trim();return data[c].map[d].model}catch(e){return null}}var config={serverPort:8080,mongoConnectString:"mongodb://localhost/test",sessionSecret:"nfuds9543ythhfgjghf$WH*#IRF5euyhtfgxkj",multipartLimit:"1099mb",useGfs:!1,cloudinaryConfig:{cloud_name:"hackettmill",api_key:"927166441966584",api_secret:"nJpv1R7U_-uhuvxiaJar8ihqUBg"},s3Config:{}};module.exports=config,exports.models=require("./models"),exports.migrate=require("./migrate"),exports.workflow=require("./workflow"),exports.config=require("./config");var fs=require("fs"),csv=require("csv"),mongoose=require("mongoose"),cloudinary=require("cloudinary"),uuid=require("node-uuid"),workflow=require("./workflow"),cms=require("../modules/cms"),data={},path=__dirname+"/migrate/HackettMillServer_Backup_2014_02_27_100100/",use_existing_images=!0,prefix="dev1",_job,_done;exports.migrate_data=function(a,b){return _job&&a?void _done(new Error("migration is in progress")):(_job=a,_done=b,void(use_existing_images?migrate0():cloudinary.api.delete_resources_by_prefix(prefix,function(a){console.log("   ... deleted "+a+" cloduinary resources"),migrate_delete_resources0()})))};var mongoose=require("mongoose"),ObjectId=mongoose.Schema.Types.ObjectId,cms=require("../modules/cms/models");exports.models={Inventory:{meta:{plural:"Inventory",name:"<%= title %>",dashboard:!0},schema:{title:String,code:String,description:String,resources:[{type:ObjectId,ref:"Resource"}],use:String,alignment:String,year:String,materials:String,dimensions:String},browse:[{name:"title",cell:"char",filters:["$regex","="],order:"asc,desc"},{name:"code",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"resources",cell:"image"},{name:"year",cell:"string",filters:["$regex"],order:"asc,desc"},{name:"modified",cell:"int",filters:["$gt","$lt","$gte","$lte"],order:"asc,desc"},{name:"state",cell:"int",filters:["="],order:"asc,desc"}],form:[{begin:"row"},{begin:"col",options:{className:"two-col"}},{name:"title",widget:"input",options:{className:"large",width:"80%"}},{name:"code",widget:"input",options:{className:"large",width:"20%"}},{end:"col"},{begin:"col",options:{className:"two-col"}},{name:"resources",widget:"upload",options:{type:"Resource",array:!0}},{end:"col"},{end:"row"},{name:"description",widget:"rich_text"},{begin:"row"},{begin:"col",options:{className:"two-col"}},{name:"use",widget:"input",help:"More details about the use."},{name:"alignment",widget:"input"},{name:"year",widget:"input"},{end:"col"},{begin:"col",options:{className:"two-col"}},{name:"materials",widget:"input"},{name:"dimensions",widget:"input"},{end:"col"},{end:"row"}]},Artist:{meta:{plural:"Artists",name:"<%= first_name %> <%= last_name %>",dashboard:!0},schema:{first_name:String,last_name:String,description:String,work:[{type:ObjectId,ref:"Inventory"}]},browse:[{name:"first_name",cell:"char",filters:["$regex","="],order:"asc,desc"},{name:"last_name",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"modified",cell:"int",filters:["$gt","$lt","$gte","$lte"],order:"asc,desc"}],form:[{begin:"row"},{begin:"col",options:{className:"two-col"}},{name:"first_name",widget:"input"},{name:"last_name",widget:"input"},{name:"description",widget:"rich_text"},{end:"col"},{begin:"col",options:{className:"two-col"}},{name:"work",widget:"choose_create",options:{type:"Inventory",array:!0}},{end:"col"},{end:"row"}]},Exhibition:{meta:{plural:"Exhibitions",name:"<%= title %>",dashboard:!0},schema:{title:String,subtitle:String,images:[{type:ObjectId,ref:"Inventory"}],start_date:Date,end_date:Date,opening_date:Date,opening_length:String,essays:[{type:ObjectId,ref:"Essay"}],catalog:{type:ObjectId,ref:"Catalog"}},browse:[{name:"title",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"subtitle",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"start_date",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"end_date",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"opening_date",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"modified",cell:"char",filters:["$regex","="],order:"asc,desc,default"}],form:[{name:"title",widget:"input"},{name:"subtitle",widget:"input"},{begin:"row"},{begin:"col",options:{className:"two-col"}},{name:"images",widget:"choose_create",options:{type:"Inventory",array:!0}},{end:"col"},{begin:"col",options:{className:"two-col"}},{name:"start_date",widget:"date"},{name:"end_date",widget:"date"},{name:"opening_date",widget:"date"},{name:"opening_length",widget:"number"},{name:"essays",widget:"choose_create",options:{type:"Essay",array:!0}},{name:"catalog",widget:"choose_create",options:{type:"Catalog",array:!1}},{end:"col"},{end:"row"}]},Contact:{meta:{plural:"Contacts",name:"<%= title %>",dashboard:!0},schema:{title:String,overview:String,directions:String,address_line_1:String,address_line_2:String,city:String,state:String,zip:String,email:String,phone:String,mobile:String},browse:[{name:"title",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"overview",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"directions",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"address_line_1",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"address_line_2",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"city",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"state",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"zip",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"email",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"modified",cell:"char",filters:["$regex","="],order:"asc,desc,default"}],form:[{name:"title",widget:"input"},{name:"overview",widget:"rich_text"},{name:"directions",widget:"rich_text"},{name:"address_line_1",widget:"input"},{name:"address_line_2",widget:"input"},{name:"city",widget:"input"},{name:"zip",widget:"input"},{name:"email",widget:"input"},{name:"phone",widget:"input"},{name:"mobile",widget:"input"}]},Essay:{meta:{plural:"Essays",name:"<%= title1 %>"},schema:{title1:String,title2:String,title3:String,author:String,audio_bio:String,body:String},browse:[{name:"title1",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"title2",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"author",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"modified",cell:"char",filters:["$regex","="],order:"asc,desc,default"}],form:[{name:"title1",widget:"input"},{name:"title2",widget:"input"},{name:"title3",widget:"input"},{name:"author",widget:"input"},{name:"audio_bio",widget:"input"},{name:"body",widget:"input"}]},Catalog:{meta:{plural:"Catalogs",name:"<%= title %>"},schema:{price:Number,title:String,caption:String,images:[{type:ObjectId,ref:"Resource"}]},browse:[{name:"title",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"price",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"images",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"modified",cell:"char",filters:["$regex","="],order:"asc,desc,default"}],form:[{name:"price",widget:"input"},{name:"title",widget:"input"},{name:"caption",widget:"input"},{name:"images",widget:"choose_create",options:{type:"Resource",array:!0}}]},Page:{meta:{plural:"Pages",name:"<%= title %>",dashboard:!0},schema:{title:String,subtitle:String,body:String,pages:[{type:ObjectId,ref:"Page"}]},browse:[{name:"title",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"subtitle",cell:"char",filters:["$regex","="],order:"asc,desc"},{name:"modified",cell:"int",filters:["$gt","$lt","$gte","$lte"],order:"asc,desc"}],form:[{name:"title",widget:"input"},{name:"subtitle",widget:"input"},{name:"body",widget:"rich_text"},{name:"pages",widget:"choose_create",options:{type:"Page",array:!0}}]},News:{meta:{plural:"News",name:"<%= title %>",dashboard:!0},schema:{title:String,subtitle:String,body:String,release_date:Date},browse:[{name:"title",cell:"char",filters:["$regex","="],order:"asc,desc,default"},{name:"release_date",cell:"date",filters:["$gt","$lt","$gte","$lte"],order:"asc,desc"},{name:"modified",cell:"int",filters:["$gt","$lt","$gte","$lte"],order:"asc,desc"}],form:[{name:"title",widget:"input"},{name:"subtitle",widget:"input"},{name:"body",widget:"rich_text"},{name:"release_date",widget:"date"}]},Resource:cms.models.Resource};var DRAFT=exports.DRAFT=100,PUBLISHED=exports.PUBLISHED=500,FLAGGED=exports.FLAGGED=600;exports.workflow={states:[{code:DRAFT,name:"draft",editable:!0},{code:PUBLISHED,name:"published"},{code:FLAGGED,name:"flagged"}],groups:{admin:"editor",editor:{transitions:[{from:DRAFT,to:[PUBLISHED,FLAGGED]},{from:PUBLISHED,to:[FLAGGED,DRAFT]},{from:FLAGGED,to:[PUBLISHED,DRAFT]}]},contributor:{transitions:[],requests:[{from:DRAFT,to:[PUBLISHED]},{from:PUBLISHED,to:[DRAFT]},{from:PUBLISHED,to:[FLAGGED]}]}}};